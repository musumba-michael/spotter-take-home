{% extends "admin/base_site.html" %}

{% block content %}
  <h1>{{ title }}</h1>

  <div style="max-width: 720px;">
    <p><strong>File:</strong> {{ job.original_filename }}</p>
    <p><strong>Status:</strong> <span id="status-text">{{ job.status }}</span></p>

    <div style="border: 1px solid #ccc; border-radius: 4px; height: 18px; overflow: hidden; margin: 12px 0;">
      <div id="progress-bar" style="height: 100%; width: 0%; background: #2e7d32;"></div>
    </div>
    <p id="progress-text">0%</p>

    <ul>
      <li>Processed: <span id="processed-rows">{{ job.processed_rows }}</span> / <span id="total-rows">{{ job.total_rows }}</span></li>
      <li>Created: <span id="created-count">{{ job.created_count }}</span></li>
      <li>Updated: <span id="updated-count">{{ job.updated_count }}</span></li>
      <li>Geocoded: <span id="geocoded-count">{{ job.geocoded_count }}</span></li>
      <li>Failed: <span id="failed-count">{{ job.failed_count }}</span></li>
    </ul>

    <details style="margin-top: 12px;">
      <summary>Errors</summary>
      <pre id="error-log" style="white-space: pre-wrap;">{{ job.error_log }}</pre>
    </details>
  </div>

  <script>
    (function () {
      var statusUrl = window.location.pathname.endsWith("/")
        ? window.location.pathname + "json/"
        : window.location.pathname + "/json/";

      var statusText = document.getElementById("status-text");
      var progressBar = document.getElementById("progress-bar");
      var progressText = document.getElementById("progress-text");
      var processedRows = document.getElementById("processed-rows");
      var totalRows = document.getElementById("total-rows");
      var createdCount = document.getElementById("created-count");
      var updatedCount = document.getElementById("updated-count");
      var geocodedCount = document.getElementById("geocoded-count");
      var failedCount = document.getElementById("failed-count");
      var errorLog = document.getElementById("error-log");

      function update(data) {
        statusText.textContent = data.status;
        processedRows.textContent = data.processed_rows;
        totalRows.textContent = data.total_rows;
        createdCount.textContent = data.created_count;
        updatedCount.textContent = data.updated_count;
        geocodedCount.textContent = data.geocoded_count;
        failedCount.textContent = data.failed_count;
        errorLog.textContent = data.error_log || "";
        progressBar.style.width = data.percent + "%";
        progressText.textContent = data.percent + "%";
      }

      function poll() {
        fetch(statusUrl, { credentials: "same-origin" })
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            update(data);
            if (data.status === "completed" || data.status === "failed") {
              clearInterval(timer);
            }
          })
          .catch(function () {});
      }

      var timer = setInterval(poll, 2000);
      poll();
    })();
  </script>
{% endblock %}
